#!/bin/bash
if ( test "$1" = "" || test "$2" = "") then
   echo Usage:  ./deploy VERSION_NUMBER_NCI VERSION_NUMBER_REGULAR
   echo 'NCI should usually be one higher than regular version number'
   exit 1
fi

# init/earthmask.rgb  # disable for now
ncisuffix='__nci'
uplstring='init/Helvetica.txf \
         init/earthday4096.jpg \
         init/splash.png \
         init/earthnight4096.jpg \
         init/logo.jpg'
ntpversion='ntpdate_4.2.4p5_'
if ( test "`uname -s`" = "Darwin" ) then
   # Apple Mac
   if ( test "`uname -p`" = "i386" ) then
      # Intel Mac -- name the BOINC name is i686 not i386!
      suffix='i686-apple-darwin'
      ntpdv=$ntpversion$suffix
      rm -f qcnlive-mac-intel.zip
      zip -r qcnlive-mac-intel.zip QCNLive.app \
         init/$ntpdv $uplstring \
         init/libMotionNodeAccelAPI.dylib \
            -x@exclude.lst
      rm -rf qcnusb-intel*
      cd ../qcnusb/install
      /Developer/usr/bin/packagemaker --doc installer.pmdoc --out ../../bin/qcnusb-intel.mpkg
      cd ../../bin/
      zip -r qcnusb-intel.zip qcnusb-intel.mpkg -x@exclude.lst
   else
      # PowerPC Mac
      suffix='powerpc-apple-darwin'
      ntpdv=$ntpversion$suffix
      rm -f qcnlive-mac-ppc.zip
      zip -r qcnlive-mac-ppc.zip QCNLive.app \
        init/$ntpdv $uplstring \
        init/libMotionNodeAccelAPI.dylib \
            -x@exclude.lst
      rm -rf qcnusb-ppc*
      cd ../qcnusb/install
      # /Developer/Tools/packagemaker --doc installer.pmdoc --out ../../bin/qcnusb-ppc.mpkg
      # cd ../../bin/
      # zip -r qcnusb-ppc.zip qcnusb-ppc.mpkg -x@exclude.lst
      rm -f qcnusb-ppc.zip
      zip qcnusb-ppc.zip install_ppc README.ppc.txt pre-install.sh post-install.sh qcnusb edu.stanford.qcn.qcnusb.plist
      mv qcnusb-ppc.zip ../../bin/
      cd ../../bin/
   fi
   cp qcn_$1_$suffix`uname -r` qcn_$2_$suffix
   mv qcn_$1_$suffix`uname -r` qcn_$1_$suffix$ncisuffix
   cp graphics_app=qcn_graphics_$1_$suffix`uname -r` graphics_app=qcn_graphics_$2_$suffix
   mv graphics_app=qcn_graphics_$1_$suffix`uname -r` graphics_app=qcn_graphics_$1_$suffix
else
   # Linux -- uname -p below returns 'unknown'!
   # suffix=`uname -p`-pc-linux-gnu
   suffix=i686-pc-linux-gnu
   ntpdv=$ntpversion$suffix
   cp qcn_$1_$suffix qcn_$1_$suffix$ncisuffix
   mv qcn_$1_$suffix qcn_$2_$suffix
   cp graphics_app=qcn_graphics_$1_$suffix graphics_app=qcn_graphics_$2_$suffix
   rm -f qcnlive-linux.zip
   zip -r qcnlive-linux.zip qcnlive init/Helvetica.txf init/earthmask.rgb init/earthday4096.jpg \
         init/$ntpdv $uplstring \
         init/libMotionNodeAccelAPI.so \
            -x@exclude.lst
fi
appspathone=qcn_$1_$suffix$ncisuffix
appspathtwo=qcn_$2_$suffix
rm -f qcnsftp.up
echo chdir /var/www/boinc/qcnalpha/download >> qcnsftp.up
echo put \*.zip >> qcnsftp.up
echo chdir /var/www/boinc/qcnalpha/apps/qcnalpha >> qcnsftp.up
echo -mkdir $appspathone >> qcnsftp.up
echo chdir $appspathone >> qcnsftp.up
echo put qcn_$1_$suffix$ncisuffix >> qcnsftp.up
echo put graphics_app=qcn_graphics_$1_$suffix >> qcnsftp.up
echo put init/Helvetica.txf >> qcnsftp.up
#echo put init/earthmask.rgb >> qcnsftp.up
echo put init/earthday4096.jpg >> qcnsftp.up
echo put init/earthnight4096.jpg >> qcnsftp.up
echo put init/$ntpdv >> qcnsftp.up
echo put init/logo.jpg >> qcnsftp.up
if ( test "`uname -s`" = "Darwin" ) then
   echo put init/libMotionNodeAccelAPI.dylib >> qcnsftp.up
else
   echo put init/libMotionNodeAccelAPI.so >> qcnsftp.up
fi
echo chdir ../ >> qcnsftp.up
echo -mkdir $appspathtwo >> qcnsftp.up
echo chdir $appspathtwo >> qcnsftp.up
echo put qcn_$2_$suffix >> qcnsftp.up
echo put graphics_app=qcn_graphics_$2_$suffix >> qcnsftp.up
echo put init/Helvetica.txf >> qcnsftp.up
#echo put init/earthmask.rgb >> qcnsftp.up
echo put init/earthday4096.jpg >> qcnsftp.up
echo put init/earthnight4096.jpg >> qcnsftp.up
echo put init/$ntpdv >> qcnsftp.up
echo put init/logo.jpg >> qcnsftp.up
if ( test "`uname -s`" = "Darwin" ) then
   echo put init/libMotionNodeAccelAPI.dylib >> qcnsftp.up
else
   echo put init/libMotionNodeAccelAPI.so >> qcnsftp.up
fi
echo exit >> qcnsftp.up
sftp -b qcnsftp.up carlgt1@qcn-web 
